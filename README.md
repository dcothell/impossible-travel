# ðŸš¨ Potential Impossible Travel Detection with Microsoft Sentinel

## ðŸ“Œ Overview

This lab demonstrates how to detect and investigate **potential impossible travel activity** using **Microsoft Sentinel**. Impossible travel occurs when a user logs in from multiple geographic locations within a time frame that would be physically unrealistic or suspicious. This behavior may indicate **account compromise, credential sharing, or misuse of VPNs**.

The lab covers the full SOC workflow:
- Detection rule creation
- Alert triggering
- Incident investigation
- Classification and closure
- Environment cleanup

---

## ðŸ§  Detection Objective

Detect users who authenticate from **multiple geographic locations within a 7-day period** using Azure sign-in logs, then investigate whether the behavior represents a true security threat or benign activity.

---

## ðŸ›  Tools & Technologies Used

- **Microsoft Azure**
- **Microsoft Sentinel (SIEM)**
- **Log Analytics Workspace**
- **Kusto Query Language (KQL)**
- **Azure SigninLogs**
- **NIST 800-61 Incident Response Lifecycle**
- **MITRE ATT&CK Framework**

---

## ðŸ§© MITRE ATT&CK Mapping

| Tactic | Technique |
|------|----------|
| Initial Access | **T1078 â€“ Valid Accounts** |

This detection focuses on successful authentication using legitimate cloud accounts, which aligns with the Valid Accounts technique.

---

## ðŸ” Analytics Rule Logic

The following KQL query was used to identify users who logged in from more than one unique geographic location within the past 7 days:

```kql
SigninLogs
| where TimeGenerated > ago(7d)
| summarize Count = count() by
    UserPrincipalName,
    UserId,
    City = tostring(parse_json(LocationDetails).city),
    State = tostring(parse_json(LocationDetails).state),
    Country = tostring(parse_json(LocationDetails).countryOrRegion)
| project UserPrincipalName, UserId, City, State, Country
| summarize PotentialImpossibleTravelInstances = count() by UserPrincipalName, UserId
| where PotentialImpossibleTravelInstances > 1
````

### Rule Configuration Highlights

* **Query frequency:** Every 4 hours
* **Lookback period:** 7 days
* **Alert suppression:** Enabled (5 hours)
* **Incident creation:** Enabled
* **Alert grouping:** Single incident per 24 hours

---

## ðŸš¨ Alert Triggering

Login activity was generated by authenticating to Azure from:

* A local machine
* A separate environment (VM/browser)

This created sign-in logs from different geographic locations, triggering the analytics rule.

---

## ðŸ§‘â€ðŸ’» Incident Investigation

Once the alert triggered, an incident was automatically created in Microsoft Sentinel and assigned for investigation.

### Investigation Steps

1. Incident assigned and status set to **Active**
2. Entities reviewed via Sentinel investigation graph
3. A single user account selected for analysis
4. Detailed sign-in activity reviewed using the query below:

```kql
SigninLogs
| where TimeGenerated > ago(7d)
| where UserPrincipalName == "omitted"
| project TimeGenerated,
          UserPrincipalName,
          City = tostring(parse_json(LocationDetails).city),
          State = tostring(parse_json(LocationDetails).state),
          Country = tostring(parse_json(LocationDetails).countryOrRegion)
| order by TimeGenerated desc
```

---

## ðŸ“Š Investigation Findings

* User logged in from **multiple cities within Japan** (Tokyo, Chiyoda-Ku, Himeji)
* Logins occurred **hours apart**, not minutes
* All activity remained within the same country
* Geographic distances and timing were reasonable

---

## ðŸ§¾ Incident Conclusion

**Classification:** Benign Positive

The alert functioned correctly by identifying multi-location logins; however, the behavior was consistent with normal user activity and did not indicate account compromise or malicious intent.

---

## ðŸ§¹ Post-Incident Activities

* Incident notes documented within Sentinel
* Incident closed as **Benign Positive**
* Custom analytics rule deleted
* Incident removed to maintain a clean lab environment

---

## ðŸ“š Key Takeaways

* Not all alerts indicate malicious activity
* Proper investigation and context are critical in SOC operations
* Impossible travel detections require human analysis to reduce false positives
* Alert tuning and grouping help prevent alert fatigue

---

## âœ… Lab Status

âœ” Detection created
âœ” Alert triggered
âœ” Incident investigated
âœ” Findings documented
âœ” Incident closed
âœ” Environment cleaned
